---
import Faq from "@/components/Faq.astro";
import Feature from "@/components/home/Feature.astro";
import Hero from "@/components/home/Hero.astro";
import Reasons from "@/components/home/Reasons.astro";
import Video from "@/components/home/Video.astro";
import Plan from "@/components/pricing/Plan";
import Base from "@/layouts/Base.astro";
import { getListPage, getSinglePage } from "@/lib/contentParser.astro";
import { getLangFromUrl, supportedLang } from "@/lib/utils/languageParser";
import Testimonial from "@/partials/Testimonial.astro";
import type { ContentEntryMap } from "astro:content";

export function getStaticPaths() {
  const paths = supportedLang.map((lang) => ({
    params: { lang: lang || undefined },
  }));
  return paths;
}

const { lang } = Astro.params;
const language = lang || getLangFromUrl(Astro.url);

// 🟢 Lade Inhalte wie vorher aus der Markdown-Datei
const homepage = await getListPage("homepage", lang as keyof ContentEntryMap);
const { feature, video, reason } = homepage[0].data;

// ✅ Try to load WordPress hero content (fallback to Markdown if not available)
let wpPage = null;
const isNetlify = import.meta.env.NETLIFY === "true";
const buttons = [];

if (!isNetlify) {
  const WP_API_BASE = import.meta.env.PUBLIC_WP_API_BASE || "http://odgx.local";
  const wpSlug = lang === "en" ? "homepage-en" : "homepage-de";

  try {
    const res = await fetch(`${WP_API_BASE}/wp-json/wp/v2/pages?slug=${wpSlug}`);
    const data = await res.json();
    wpPage = data.length > 0 ? data[0] : null;

    if (wpPage?.acf?.hero_button_label && wpPage?.acf?.hero_button_link) {
      buttons.push({
        label: wpPage.acf.hero_button_label,
        link: wpPage.acf.hero_button_link,
      });
    }
  } catch (err) {
    console.error("❌ Failed to fetch WordPress hero:", err);
  }
}

const wpSlug = lang === "en" ? "homepage-en" : "homepage-de";
const res = await fetch(`${import.meta.env.PUBLIC_WP_API_BASE}/wp-json/wp/v2/pages?slug=${wpSlug}`);
const data = await res.json();
const wpPage = data.length > 0 ? data[0] : null;

const buttons = [];

if (wpPage?.acf?.hero_button_label && wpPage?.acf?.hero_button_link) {
  buttons.push({
    label: wpPage.acf.hero_button_label,
    link: wpPage.acf.hero_button_link,
  });
}

const hero = {
  title: wpPage?.acf?.hero_title || "Fallback Title",
  content: wpPage?.acf?.hero_content || "<p>Fallback Text</p>",
  images: wpPage?.acf?.hero_images ? [wpPage.acf.hero_images.url] : [],
  buttons,
  client_logos: homepage[0].data.hero.client_logos,
};

---

<Base>
  <Hero {hero} />
  <Feature {feature} />
  <Video {video} />
  <Reasons {reason} />
  <Plan {plan} lang={language as string} client:only="react" />
  <Testimonial {testimonial} />
  <Faq />
</Base>
</file>
